<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ordenate Admin</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/logoweb.png">

  <!-- Tailwind CSS v4 -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <!-- Google Fonts - Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style type="text/tailwindcss">
    @theme {
      --font-sans: 'Poppins', sans-serif;

      /* Paleta General del Sitio (Dark Tech) */
      --color-main: #0B0F15;
      --color-sec: #11141E;
      --color-card: #1A1D2D;
      --color-border: #2E3245;
      --color-accent: #4F46E5;
    }
  </style>

  <style>
    * {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    body { font-family: 'Poppins', sans-serif; }

    /* Modal */
    .modal { display: none; }
    .modal.active { display: flex; }

    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #11141E; }
    ::-webkit-scrollbar-thumb { background: #2E3245; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #4F46E5; }
  </style>
</head>
<body class="bg-main text-gray-100 min-h-screen">
  <!-- Login -->
  <div class="min-h-screen flex justify-center items-center bg-gradient-to-br from-main via-sec to-card" id="loginPage">
    <div class="bg-card p-10 rounded-2xl shadow-2xl w-full max-w-md border border-border">
      <div class="flex items-center justify-center gap-3 mb-8">
        <img src="/logoweb.png" alt="Ordenate" class="w-10 h-10">
        <h1 class="text-2xl font-semibold text-white">Ordenate<span class="text-accent">.Admin</span></h1>
      </div>
      <div class="text-red-400 text-center mb-4 hidden" id="loginError">Credenciales incorrectas</div>
      <input type="text" id="username" placeholder="Usuario" autocomplete="username"
        class="w-full px-4 py-3 mb-4 bg-sec border border-border rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-accent transition">
      <input type="password" id="password" placeholder="Password" autocomplete="current-password"
        class="w-full px-4 py-3 mb-6 bg-sec border border-border rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-accent transition">
      <button onclick="login()"
        class="w-full py-3 bg-accent hover:bg-indigo-500 text-white font-semibold rounded-xl transition shadow-lg shadow-accent/30">
        Ingresar
      </button>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="hidden" id="dashboard">
    <!-- Sidebar -->
    <aside class="fixed left-0 top-0 w-56 h-screen bg-sec border-r border-border flex flex-col">
      <div class="p-5 border-b border-border">
        <div class="flex items-center gap-2">
          <img src="/logoweb.png" alt="Ordenate" class="w-7 h-7">
          <span class="font-semibold text-white">Ordenate<span class="text-accent">.Admin</span></span>
        </div>
      </div>
      <nav class="flex-1 py-4">
        <a href="#" class="nav-link active" data-section="overview">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
          Dashboard
        </a>
        <a href="#" class="nav-link" data-section="users">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
          Usuarios
        </a>
        <a href="#" class="nav-link" data-section="costs">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          Costos
        </a>
      </nav>
      <div class="p-4 border-t border-border">
        <button onclick="logout()"
          class="w-full py-2 px-4 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-lg transition text-sm font-medium">
          Cerrar Sesion
        </button>
      </div>
    </aside>

    <style>
      .nav-link {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 20px;
        color: #9CA3AF;
        text-decoration: none;
        transition: all 0.2s;
        border-left: 3px solid transparent;
      }
      .nav-link:hover { background: #1A1D2D; color: white; }
      .nav-link.active { background: #1A1D2D; color: white; border-left-color: #4F46E5; }
    </style>

    <!-- Main Content -->
    <main class="ml-56 p-8 min-h-screen">
      <!-- Overview Section -->
      <div class="section active" id="overview">
        <h1 class="text-2xl font-semibold text-white mb-6">Dashboard</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5" id="kpiGrid">
          <div class="bg-card rounded-xl p-6 border border-border animate-pulse">
            <div class="h-4 bg-border rounded w-24 mb-3"></div>
            <div class="h-8 bg-border rounded w-16"></div>
          </div>
        </div>
      </div>

      <!-- Users Section -->
      <div class="section hidden" id="users">
        <h1 class="text-2xl font-semibold text-white mb-6">Usuarios</h1>
        <div class="bg-card rounded-xl border border-border overflow-hidden">
          <div class="p-5 border-b border-border flex flex-wrap gap-4 items-center justify-between">
            <h2 class="text-lg font-medium text-white">Lista de Usuarios</h2>
            <div class="flex gap-3">
              <input type="text" id="searchInput" placeholder="Buscar telefono o nombre..."
                class="px-4 py-2 bg-sec border border-border rounded-lg text-white placeholder-gray-500 text-sm focus:outline-none focus:border-accent w-56">
              <select id="planFilter"
                class="px-4 py-2 bg-sec border border-border rounded-lg text-white text-sm focus:outline-none focus:border-accent">
                <option value="">Todos los planes</option>
                <option value="free">Free</option>
                <option value="premium">Premium</option>
              </select>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="bg-sec/50">
                  <th class="px-5 py-3 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Usuario</th>
                  <th class="px-5 py-3 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Plan</th>
                  <th class="px-5 py-3 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Transacciones</th>
                  <th class="px-5 py-3 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Ultima Actividad</th>
                  <th class="px-5 py-3 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Registro</th>
                  <th class="px-5 py-3"></th>
                </tr>
              </thead>
              <tbody id="usersTable" class="divide-y divide-border">
                <tr><td colspan="6" class="px-5 py-8 text-center text-gray-500">Cargando...</td></tr>
              </tbody>
            </table>
          </div>
          <div class="p-4 flex justify-center gap-2" id="pagination"></div>
        </div>
      </div>

      <!-- Costs Section -->
      <div class="section hidden" id="costs">
        <h1 class="text-2xl font-semibold text-white mb-6">Costos Operativos</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5" id="costsGrid">
          <div class="bg-card rounded-xl p-6 border border-border animate-pulse">
            <div class="h-5 bg-border rounded w-32 mb-4"></div>
            <div class="h-4 bg-border rounded w-full mb-2"></div>
            <div class="h-4 bg-border rounded w-3/4"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- User Detail Modal -->
  <div class="modal fixed inset-0 bg-black/70 z-50 justify-center items-center p-4" id="userModal">
    <div class="bg-card rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden border border-border">
      <div class="p-5 border-b border-border flex justify-between items-center">
        <h2 class="text-xl font-semibold text-white">Detalle de Usuario</h2>
        <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
      </div>
      <div class="p-5 overflow-y-auto max-h-[calc(90vh-80px)]" id="userModalBody">
        <div class="text-gray-500 text-center py-8">Cargando...</div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '';
    let authToken = localStorage.getItem('adminToken');
    let currentPage = 1;

    // Check auth on load
    if (authToken) {
      showDashboard();
      loadDashboard();
    }

    // Login
    async function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const errorEl = document.getElementById('loginError');

      try {
        const res = await fetch(`${API_BASE}/api/admin/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await res.json();

        if (res.ok && data.token) {
          authToken = data.token;
          localStorage.setItem('adminToken', authToken);
          errorEl.classList.add('hidden');
          showDashboard();
          loadDashboard();
        } else {
          errorEl.classList.remove('hidden');
        }
      } catch (err) {
        errorEl.textContent = 'Error de conexion';
        errorEl.classList.remove('hidden');
      }
    }

    function logout() {
      localStorage.removeItem('adminToken');
      authToken = null;
      document.getElementById('loginPage').classList.remove('hidden');
      document.getElementById('dashboard').classList.add('hidden');
    }

    function showDashboard() {
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
    }

    // API calls
    async function apiCall(endpoint) {
      const res = await fetch(`${API_BASE}${endpoint}`, {
        headers: { 'Authorization': `Basic ${authToken}` }
      });
      if (res.status === 401) {
        logout();
        throw new Error('Unauthorized');
      }
      return res.json();
    }

    // Load Dashboard
    async function loadDashboard() {
      try {
        const data = await apiCall('/api/admin/dashboard');
        renderKPIs(data);
      } catch (err) {
        console.error('Dashboard error:', err);
      }
    }

    function renderKPIs(data) {
      const grid = document.getElementById('kpiGrid');
      grid.innerHTML = `
        <div class="bg-gradient-to-br from-accent to-indigo-600 rounded-xl p-6 shadow-lg shadow-accent/20">
          <h3 class="text-sm font-medium text-white/80 uppercase tracking-wide">Total Usuarios</h3>
          <div class="text-4xl font-bold text-white mt-2">${data.users.total}</div>
          <div class="text-sm text-white/70 mt-2">+${data.users.thisMonth} este mes</div>
        </div>
        <div class="bg-card rounded-xl p-6 border border-border hover:border-accent/50 transition">
          <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wide">Usuarios Activos (MAU)</h3>
          <div class="text-4xl font-bold text-white mt-2">${data.activity.mau}</div>
          <div class="text-sm text-gray-500 mt-2">DAU: ${data.activity.dau} | WAU: ${data.activity.wau}</div>
        </div>
        <div class="bg-card rounded-xl p-6 border border-border hover:border-accent/50 transition">
          <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wide">Transacciones</h3>
          <div class="text-4xl font-bold text-white mt-2">${data.transactions.total.toLocaleString()}</div>
          <div class="text-sm text-gray-500 mt-2">${data.transactions.thisMonth.toLocaleString()} este mes</div>
        </div>
        <div class="bg-card rounded-xl p-6 border border-border hover:border-accent/50 transition">
          <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wide">Promedio Tx/Usuario</h3>
          <div class="text-4xl font-bold text-white mt-2">${data.transactions.avgPerUser}</div>
          <div class="text-sm text-gray-500 mt-2">Por usuario activo</div>
        </div>
        <div class="bg-card rounded-xl p-6 border border-border hover:border-accent/50 transition">
          <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wide">Total Gastos Registrados</h3>
          <div class="text-4xl font-bold text-white mt-2">$${(data.transactions.totalExpenses / 1000000).toFixed(1)}M</div>
          <div class="text-sm text-gray-500 mt-2">Ingresos: $${(data.transactions.totalIncome / 1000000).toFixed(1)}M</div>
        </div>
        <div class="bg-card rounded-xl p-6 border border-border hover:border-accent/50 transition">
          <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wide">Usuarios con Gastos Fijos</h3>
          <div class="text-4xl font-bold text-white mt-2">${data.fixedExpenses.usersWithFixed}</div>
          <div class="text-sm text-gray-500 mt-2">${data.fixedExpenses.totalFixed} gastos fijos totales</div>
        </div>
        <div class="bg-card rounded-xl p-6 border border-border hover:border-accent/50 transition">
          <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wide">Plan Free</h3>
          <div class="text-4xl font-bold text-white mt-2">${data.users.byPlan.free || 0}</div>
          <div class="text-sm text-gray-500 mt-2">${((data.users.byPlan.free || 0) / data.users.total * 100).toFixed(1)}% del total</div>
        </div>
        <div class="bg-card rounded-xl p-6 border border-border hover:border-accent/50 transition">
          <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wide">Plan Premium</h3>
          <div class="text-4xl font-bold text-white mt-2">${data.users.byPlan.premium || 0}</div>
          <div class="text-sm text-gray-500 mt-2">${((data.users.byPlan.premium || 0) / data.users.total * 100).toFixed(1)}% del total</div>
        </div>
      `;
    }

    // Load Users
    async function loadUsers(page = 1) {
      currentPage = page;
      const search = document.getElementById('searchInput').value;
      const plan = document.getElementById('planFilter').value;

      let url = `/api/admin/users?page=${page}&limit=15`;
      if (search) url += `&search=${encodeURIComponent(search)}`;
      if (plan) url += `&plan=${plan}`;

      try {
        const data = await apiCall(url);
        renderUsers(data);
      } catch (err) {
        console.error('Users error:', err);
      }
    }

    function renderUsers(data) {
      const tbody = document.getElementById('usersTable');
      const pagination = document.getElementById('pagination');

      if (data.users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-5 py-8 text-center text-gray-500">No se encontraron usuarios</td></tr>';
        pagination.innerHTML = '';
        return;
      }

      tbody.innerHTML = data.users.map(u => `
        <tr class="hover:bg-sec/50 transition">
          <td class="px-5 py-4">
            <div class="font-medium text-white">${u.name || 'Sin nombre'}</div>
            <div class="text-sm text-gray-500">${u.phone}</div>
          </td>
          <td class="px-5 py-4">
            <span class="px-3 py-1 rounded-full text-xs font-medium ${u.plan === 'premium' ? 'bg-amber-500/10 text-amber-400' : 'bg-green-500/10 text-green-400'}">
              ${u.plan}
            </span>
          </td>
          <td class="px-5 py-4 text-gray-300">${u.transactionCount}</td>
          <td class="px-5 py-4 text-gray-300">${u.lastInteraction ? new Date(u.lastInteraction).toLocaleDateString('es-CL') : '-'}</td>
          <td class="px-5 py-4 text-gray-300">${new Date(u.createdAt).toLocaleDateString('es-CL')}</td>
          <td class="px-5 py-4">
            <button onclick="viewUser(${u.id})" class="px-3 py-1.5 bg-accent/10 hover:bg-accent/20 text-accent rounded-lg text-sm font-medium transition">
              Ver
            </button>
          </td>
        </tr>
      `).join('');

      // Pagination
      const { page, totalPages } = data.pagination;
      let paginationHTML = '';

      paginationHTML += `<button ${page === 1 ? 'disabled' : ''} onclick="loadUsers(${page - 1})"
        class="px-3 py-1.5 rounded-lg text-sm font-medium transition ${page === 1 ? 'bg-border/50 text-gray-600 cursor-not-allowed' : 'bg-sec border border-border text-gray-300 hover:border-accent'}">
        Anterior
      </button>`;

      for (let i = 1; i <= totalPages && i <= 5; i++) {
        paginationHTML += `<button onclick="loadUsers(${i})"
          class="px-3 py-1.5 rounded-lg text-sm font-medium transition ${i === page ? 'bg-accent text-white' : 'bg-sec border border-border text-gray-300 hover:border-accent'}">
          ${i}
        </button>`;
      }

      paginationHTML += `<button ${page === totalPages ? 'disabled' : ''} onclick="loadUsers(${page + 1})"
        class="px-3 py-1.5 rounded-lg text-sm font-medium transition ${page === totalPages ? 'bg-border/50 text-gray-600 cursor-not-allowed' : 'bg-sec border border-border text-gray-300 hover:border-accent'}">
        Siguiente
      </button>`;

      pagination.innerHTML = paginationHTML;
    }

    // View User Detail
    async function viewUser(id) {
      document.getElementById('userModal').classList.add('active');
      document.getElementById('userModalBody').innerHTML = '<div class="text-gray-500 text-center py-8">Cargando...</div>';

      try {
        const data = await apiCall(`/api/admin/users/${id}`);
        renderUserDetail(data);
      } catch (err) {
        document.getElementById('userModalBody').innerHTML = '<p class="text-red-400">Error cargando usuario</p>';
      }
    }

    function renderUserDetail(data) {
      const { user, stats, recentTransactions, fixedExpenses } = data;

      document.getElementById('userModalBody').innerHTML = `
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div class="bg-sec/50 rounded-lg p-4">
            <div class="text-xs text-gray-500 uppercase tracking-wide">Nombre</div>
            <div class="text-white mt-1">${user.name || 'Sin nombre'}</div>
          </div>
          <div class="bg-sec/50 rounded-lg p-4">
            <div class="text-xs text-gray-500 uppercase tracking-wide">Telefono</div>
            <div class="text-white mt-1">${user.phone}</div>
          </div>
          <div class="bg-sec/50 rounded-lg p-4">
            <div class="text-xs text-gray-500 uppercase tracking-wide">Plan</div>
            <div class="mt-1">
              <span class="px-2 py-0.5 rounded-full text-xs font-medium ${user.plan === 'premium' ? 'bg-amber-500/10 text-amber-400' : 'bg-green-500/10 text-green-400'}">
                ${user.plan}
              </span>
            </div>
          </div>
          <div class="bg-sec/50 rounded-lg p-4">
            <div class="text-xs text-gray-500 uppercase tracking-wide">Ingreso Mensual</div>
            <div class="text-white mt-1">$${user.monthlyIncome ? user.monthlyIncome.toLocaleString('es-CL') : '-'}</div>
          </div>
          <div class="bg-sec/50 rounded-lg p-4">
            <div class="text-xs text-gray-500 uppercase tracking-wide">Meta de Ahorro</div>
            <div class="text-white mt-1">$${user.savingsGoal ? user.savingsGoal.toLocaleString('es-CL') : '-'}</div>
          </div>
          <div class="bg-sec/50 rounded-lg p-4">
            <div class="text-xs text-gray-500 uppercase tracking-wide">Registro</div>
            <div class="text-white mt-1">${new Date(user.createdAt).toLocaleDateString('es-CL')}</div>
          </div>
          <div class="bg-sec/50 rounded-lg p-4">
            <div class="text-xs text-gray-500 uppercase tracking-wide">Ultima Actividad</div>
            <div class="text-white mt-1">${user.lastInteraction ? new Date(user.lastInteraction).toLocaleString('es-CL') : '-'}</div>
          </div>
          <div class="bg-sec/50 rounded-lg p-4">
            <div class="text-xs text-gray-500 uppercase tracking-wide">Onboarding</div>
            <div class="text-white mt-1">${user.onboardingComplete ? 'Completado' : 'Paso ' + (user.onboardingStep || 1)}</div>
          </div>
        </div>

        <h3 class="text-lg font-medium text-white mb-3">Estadisticas</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-sec/50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-white">${stats.totalTransactions}</div>
            <div class="text-xs text-gray-500 mt-1">Total Tx</div>
          </div>
          <div class="bg-sec/50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-white">${stats.transactionsThisMonth}</div>
            <div class="text-xs text-gray-500 mt-1">Este Mes</div>
          </div>
          <div class="bg-sec/50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-red-400">$${(stats.totalExpenses / 1000).toFixed(0)}K</div>
            <div class="text-xs text-gray-500 mt-1">Gastos</div>
          </div>
          <div class="bg-sec/50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-green-400">$${(stats.totalIncome / 1000).toFixed(0)}K</div>
            <div class="text-xs text-gray-500 mt-1">Ingresos</div>
          </div>
        </div>

        <h3 class="text-lg font-medium text-white mb-3">Gastos Fijos (${fixedExpenses.length})</h3>
        ${fixedExpenses.length > 0 ? `
          <div class="bg-sec/30 rounded-lg overflow-hidden mb-6">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-border">
                  <th class="px-4 py-2 text-left text-xs text-gray-500 uppercase">Descripcion</th>
                  <th class="px-4 py-2 text-left text-xs text-gray-500 uppercase">Monto</th>
                  <th class="px-4 py-2 text-left text-xs text-gray-500 uppercase">Dia</th>
                  <th class="px-4 py-2 text-left text-xs text-gray-500 uppercase">Estado</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border/50">
                ${fixedExpenses.map(f => `
                  <tr>
                    <td class="px-4 py-2 text-gray-300">${f.category_emoji || ''} ${f.description}</td>
                    <td class="px-4 py-2 text-gray-300">$${parseFloat(f.typical_amount).toLocaleString('es-CL')}</td>
                    <td class="px-4 py-2 text-gray-300">${f.reminder_day || '-'}</td>
                    <td class="px-4 py-2">
                      <span class="px-2 py-0.5 rounded text-xs ${f.is_active ? 'bg-green-500/10 text-green-400' : 'bg-gray-500/10 text-gray-400'}">
                        ${f.is_active ? 'Activo' : 'Pausado'}
                      </span>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : '<p class="text-gray-500 mb-6">Sin gastos fijos</p>'}

        <h3 class="text-lg font-medium text-white mb-3">Ultimas Transacciones</h3>
        ${recentTransactions.length > 0 ? `
          <div class="bg-sec/30 rounded-lg overflow-hidden">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-border">
                  <th class="px-4 py-2 text-left text-xs text-gray-500 uppercase">Fecha</th>
                  <th class="px-4 py-2 text-left text-xs text-gray-500 uppercase">Descripcion</th>
                  <th class="px-4 py-2 text-left text-xs text-gray-500 uppercase">Monto</th>
                  <th class="px-4 py-2 text-left text-xs text-gray-500 uppercase">Tipo</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border/50">
                ${recentTransactions.slice(0, 5).map(t => `
                  <tr>
                    <td class="px-4 py-2 text-gray-300">${new Date(t.date).toLocaleDateString('es-CL')}</td>
                    <td class="px-4 py-2 text-gray-300">${t.category_emoji || ''} ${t.description || t.category_name}</td>
                    <td class="px-4 py-2 text-gray-300">$${parseFloat(t.amount).toLocaleString('es-CL')}</td>
                    <td class="px-4 py-2">
                      <span class="px-2 py-0.5 rounded text-xs ${t.is_income ? 'bg-green-500/10 text-green-400' : 'bg-red-500/10 text-red-400'}">
                        ${t.is_income ? 'Ingreso' : 'Gasto'}
                      </span>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : '<p class="text-gray-500">Sin transacciones</p>'}
      `;
    }

    function closeModal() {
      document.getElementById('userModal').classList.remove('active');
    }

    // Load Costs
    async function loadCosts() {
      try {
        const data = await apiCall('/api/admin/costs/summary');
        renderCosts(data);
      } catch (err) {
        console.error('Costs error:', err);
        document.getElementById('costsGrid').innerHTML = '<p class="text-red-400">Error cargando costos</p>';
      }
    }

    function renderCosts(data) {
      const grid = document.getElementById('costsGrid');

      grid.innerHTML = `
        <div class="bg-card rounded-xl p-6 border border-border">
          <div class="flex items-center gap-3 mb-4 pb-4 border-b border-border">
            <div class="w-10 h-10 bg-orange-500/10 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
            </div>
            <h3 class="text-lg font-medium text-white">Claude API (Anthropic)</h3>
          </div>
          ${data.anthropic.error ? `<p class="text-red-400">${data.anthropic.error}</p>` : `
            <div class="space-y-3">
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Periodo</span>
                <span class="text-gray-300">${data.anthropic.period?.start || '-'} a ${data.anthropic.period?.end || '-'}</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Modelo</span>
                <span class="text-gray-300">${data.anthropic.summary?.model || 'Haiku'}</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Costo Input</span>
                <span class="text-gray-300">$${(data.anthropic.summary?.inputCost || 0).toFixed(4)} USD</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Costo Output</span>
                <span class="text-gray-300">$${(data.anthropic.summary?.outputCost || 0).toFixed(4)} USD</span>
              </div>
              <div class="flex justify-between pt-3 mt-3 border-t border-border">
                <span class="font-medium text-white">Costo Total</span>
                <span class="font-bold text-accent">$${(data.anthropic.summary?.totalCost || 0).toFixed(2)} USD</span>
              </div>
            </div>
          `}
        </div>

        <div class="bg-card rounded-xl p-6 border border-border">
          <div class="flex items-center gap-3 mb-4 pb-4 border-b border-border">
            <div class="w-10 h-10 bg-red-500/10 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
            </div>
            <h3 class="text-lg font-medium text-white">Twilio (WhatsApp)</h3>
          </div>
          ${data.twilio.error ? `<p class="text-red-400">${data.twilio.error}</p>` : `
            <div class="space-y-3">
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Periodo</span>
                <span class="text-gray-300">${data.twilio.period?.start || '-'} a ${data.twilio.period?.end || '-'}</span>
              </div>
              <div class="flex justify-between pt-3 mt-3 border-t border-border">
                <span class="font-medium text-white">Costo Total</span>
                <span class="font-bold text-accent">$${(data.twilio.summary?.totalCost || 0).toFixed(2)} USD</span>
              </div>
            </div>
          `}
        </div>

        <div class="bg-card rounded-xl p-6 border border-border">
          <div class="flex items-center gap-3 mb-4 pb-4 border-b border-border">
            <div class="w-10 h-10 bg-purple-500/10 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path></svg>
            </div>
            <h3 class="text-lg font-medium text-white">Railway (Hosting)</h3>
          </div>
          ${data.railway.error ? `<p class="text-red-400">${data.railway.error}</p>` : `
            <div class="space-y-3">
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Proyecto</span>
                <span class="text-gray-300">${data.railway.project?.name || '-'}</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Servicios</span>
                <span class="text-gray-300">${data.railway.project?.services?.edges?.length || 0}</span>
              </div>
              <p class="text-xs text-gray-500 pt-3 mt-3 border-t border-border">${data.railway.note || 'Ver dashboard.railway.app para costos detallados'}</p>
            </div>
          `}
        </div>
      `;
    }

    // Navigation
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const section = e.currentTarget.dataset.section;

        // Update active nav
        document.querySelectorAll('.nav-link').forEach(a => a.classList.remove('active'));
        e.currentTarget.classList.add('active');

        // Show section
        document.querySelectorAll('.section').forEach(s => {
          s.classList.add('hidden');
          s.classList.remove('active');
        });
        const sectionEl = document.getElementById(section);
        sectionEl.classList.remove('hidden');
        sectionEl.classList.add('active');

        // Load data
        if (section === 'overview') loadDashboard();
        if (section === 'users') loadUsers();
        if (section === 'costs') loadCosts();
      });
    });

    // Search/filter events
    document.getElementById('searchInput').addEventListener('keyup', debounce(() => loadUsers(1), 500));
    document.getElementById('planFilter').addEventListener('change', () => loadUsers(1));

    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // Close modal on outside click
    document.getElementById('userModal').addEventListener('click', (e) => {
      if (e.target.id === 'userModal') closeModal();
    });

    // Enter key on login
    document.getElementById('password').addEventListener('keyup', (e) => {
      if (e.key === 'Enter') login();
    });
  </script>
</body>
</html>
